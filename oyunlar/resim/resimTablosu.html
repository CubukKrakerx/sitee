<!doctype html>
<html lang="tr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√áizim Tahtasƒ±</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        html {
            height: 100%;
        }

        .drawing-app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: row;
        }

        .sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .header {
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            background: white;
        }

        h1 {
            margin: 0;
            font-size: 1.4em;
            font-weight: bold;
        }

        .toolbar {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .color-btn {
            width: 45px;
            height: 45px;
            border: 3px solid transparent;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.15);
        }

        .color-picker-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        #customColorPicker {
            width: 100%;
            height: 45px;
            border: 3px solid #333;
            border-radius: 8px;
            cursor: pointer;
        }

        .gradient-btn {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: linear-gradient(to right, #FF0000, #FFA500, #FFFF00, #00FF00, #0000FF, #4B0082, #9400D3);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gradient-btn:hover {
            transform: scale(1.05);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-weight: bold;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            outline: none;
            appearance: none;
            background: #4CAF50;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            background: #4CAF50;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            background: #4CAF50;
        }

        .tool-btn {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }

        .tool-btn:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        .tool-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        .tools-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .section-label {
            font-weight: bold;
            font-size: 0.95em;
            margin-bottom: 5px;
            color: #555;
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }

        .canvas-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background: white;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: crosshair;
        }

        .sticker-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: none;
            gap: 10px;
            flex-wrap: wrap;
            max-width: 400px;
            max-height: 60%;
            overflow-y: auto;
        }

        .sticker-panel.show {
            display: flex;
        }

        .sticker-label {
            width: 100%;
            text-align: center;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .sticker-btn {
            font-size: 2em;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sticker-btn:hover {
            transform: scale(1.2);
            border-color: #333;
        }

        .action-buttons {
            padding: 12px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            border-top: 2px solid #e0e0e0;
            background: #f8f9fa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .text-input-overlay {
            position: absolute;
            display: none;
            pointer-events: none;
        }

        .text-input-overlay input {
            font-size: 24px;
            border: 2px dashed #333;
            padding: 5px;
            background: rgba(255, 255, 255, 0.9);
            pointer-events: all;
        }

        @media (max-width: 768px) {
            .drawing-app {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: 40%;
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
            h1 { font-size: 1.2em; }
            .toolbar { gap: 10px; }
            .color-palette { grid-template-columns: repeat(6, 1fr); }
            .color-btn { width: 40px; height: 40px; }
            .sticker-panel { max-width: 300px; }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="drawing-app">
   <div class="sidebar">
    <header class="header">
     <h1 id="mainTitle">üé® √áizim Tahtasƒ±</h1>
    </header>
    <div class="toolbar">
     <div class="tools-section">
      <div class="section-label" id="toolsLabel">
       Ara√ßlar
      </div><button class="tool-btn active" onclick="selectTool('brush')">üñåÔ∏è Fƒ±r√ßa</button> <button class="tool-btn" onclick="selectTool('rainbow')">üåà G√∂kku≈üaƒüƒ±</button> <button class="tool-btn" onclick="selectTool('fill')">ü™£ Dolgu</button> <button class="tool-btn" onclick="selectTool('text')">üìù Metin</button> <button class="tool-btn" id="eraserBtn" onclick="selectTool('eraser')">üßπ Silgi</button> <button class="tool-btn" onclick="toggleGlow()">‚ú® Parlama</button>
     </div>
     <div class="tools-section">
      <div class="section-label" id="shapesLabel">
       ≈ûekiller
      </div><button class="tool-btn" onclick="selectTool('circle')">‚≠ï Daire</button> <button class="tool-btn" onclick="selectTool('rectangle')">‚¨ú Kare</button> <button class="tool-btn" onclick="selectTool('triangle')">üî∫ √ú√ßgen</button> <button class="tool-btn" onclick="selectTool('line')">üìè √áizgi</button>
     </div>
     <div class="tools-section">
      <div class="section-label" id="brushTypesLabel">
       Fƒ±r√ßa Tipleri
      </div><button class="tool-btn active" id="roundBrush" onclick="selectBrushType('round')">‚ö´ Yuvarlak</button> <button class="tool-btn" id="squareBrush" onclick="selectBrushType('square')">‚¨õ Kare</button> <button class="tool-btn" id="softBrush" onclick="selectBrushType('soft')">üå´Ô∏è Yumu≈üak</button>
     </div>
     <div class="tools-section">
      <div class="section-label">
       Renkler
      </div>
      <div class="color-palette" id="colorPalette"></div>
      <div class="color-picker-wrapper"><input type="color" id="customColorPicker" value="#000000" title="√ñzel Renk"> <button class="gradient-btn" onclick="applyGradient()">üé® Gradyan Uygula</button>
      </div>
     </div>
     <div class="control-group">
      <div class="control-label"><span id="brushSizeLabel">Fƒ±r√ßa Boyutu:</span> <span id="sizeValue">5</span>
      </div><input type="range" id="brushSize" class="slider" min="1" max="50" value="5">
     </div>
     <div class="control-group">
      <div class="control-label"><span id="opacityLabel">≈ûeffaflƒ±k:</span> <span id="opacityValue">100%</span>
      </div><input type="range" id="opacitySlider" class="slider" min="0" max="100" value="100">
     </div>
    </div>
   </div>
   <div class="main-area">
    <div class="canvas-container">
     <div class="canvas-wrapper">
      <canvas id="canvas"></canvas>
      <div class="sticker-panel" id="stickerPanel">
       <div class="sticker-label" id="stickerLabel">
        Stickerlar
       </div>
      </div>
      <div class="text-input-overlay" id="textInputOverlay"><input type="text" id="textInput" placeholder="Metni yaz...">
      </div>
     </div>
    </div>
    <div class="action-buttons"><button class="btn" id="undoBtn" onclick="undo()">‚Ü∂ Geri Al</button> <button class="btn" id="redoBtn" onclick="redo()">‚Ü∑ ƒ∞leri Al</button> <button class="btn" id="stickerToggleBtn" onclick="toggleStickers()">üòä Sticker</button> <button class="btn" id="clearBtn" onclick="clearCanvas()">üóëÔ∏è Temizle</button> <button class="btn" id="downloadBtn" onclick="downloadImage()">üíæ ƒ∞ndir</button>
    </div>
   </div>
  </div>
  <script>
        const defaultConfig = {
            main_title: 'üé® √áizim Tahtasƒ±',
            brush_size_label: 'Fƒ±r√ßa Boyutu:',
            opacity_label: '≈ûeffaflƒ±k:',
            eraser_button: 'üßπ Silgi',
            undo_button: '‚Ü∂ Geri Al',
            redo_button: '‚Ü∑ ƒ∞leri Al',
            clear_button: 'üóëÔ∏è Temizle',
            download_button: 'üíæ ƒ∞ndir',
            stickers_label: 'Stickerlar',
            tools_label: 'Ara√ßlar',
            shapes_label: '≈ûekiller',
            brush_types_label: 'Fƒ±r√ßa Tipleri',
            background_color: '#ffffff',
            surface_color: '#f5f5f5',
            text_color: '#333333',
            primary_action_color: '#4CAF50',
            secondary_action_color: '#2196F3',
            font_family: 'Arial',
            font_size: 16
        };

        const colors = [
            '#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
            '#FF00FF', '#00FFFF', '#FFA500', '#800080', '#FFC0CB',
            '#A52A2A', '#808080', '#FFFFFF', '#8B4513', '#00CED1', '#FFD700'
        ];

        const stickers = ['üòä', '‚ù§Ô∏è', '‚≠ê', 'üåü', '‚ú®', 'üéâ', 'üéà', 'üé®', 'üåà', '‚òÄÔ∏è', 'üåô', '‚ö°', 'üî•', 'üí´', 'ü¶ã', 'üå∏', 'üê¢'];

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let currentColor = '#000000';
        let brushSize = 5;
        let lastX = 0;
        let lastY = 0;
        let history = [];
        let historyStep = -1;
        let currentTool = 'brush';
        let brushType = 'round';
        let opacity = 1;
        let shapeStartX = 0;
        let shapeStartY = 0;
        let isShapeDrawing = false;
        let textMode = false;
        let glowEnabled = false;
        let rainbowHue = 0;
        let tempCanvas = null;

        function resizeCanvas() {
            const wrapper = canvas.parentElement;
            const temp = document.createElement('canvas');
            const tempCtx = temp.getContext('2d');
            temp.width = canvas.width;
            temp.height = canvas.height;
            tempCtx.drawImage(canvas, 0, 0);

            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
            
            ctx.fillStyle = defaultConfig.background_color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (temp.width > 0) {
                ctx.drawImage(temp, 0, 0);
            }
            
            saveState();
        }

        function saveState() {
            historyStep++;
            if (historyStep < history.length) {
                history.length = historyStep;
            }
            history.push(canvas.toDataURL());
            if (history.length > 50) history.shift();
            updateUndoRedoButtons();
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                const img = new Image();
                img.src = history[historyStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    updateUndoRedoButtons();
                };
            }
        }

        function redo() {
            if (historyStep < history.length - 1) {
                historyStep++;
                const img = new Image();
                img.src = history[historyStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    updateUndoRedoButtons();
                };
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = historyStep <= 0;
            document.getElementById('redoBtn').disabled = historyStep >= history.length - 1;
        }

        function selectTool(tool) {
            currentTool = tool;
            
            // Parlama efekti sadece fƒ±r√ßa, g√∂kku≈üaƒüƒ± ve brush type'larla √ßalƒ±≈üsƒ±n
            if (!['brush', 'rainbow'].includes(tool)) {
                glowEnabled = false;
                const glowBtn = Array.from(document.querySelectorAll('.tool-btn')).find(btn => btn.textContent.includes('Parlama'));
                if (glowBtn) glowBtn.classList.remove('active');
            }
            
            // Sadece ara√ß butonlarƒ±nƒ± g√ºncelle (Parlama ve brush type'lar hari√ß)
            document.querySelectorAll('.tools-section:nth-child(1) .tool-btn, .tools-section:nth-child(2) .tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Tƒ±klanan butonu aktif yap (eƒüer ara√ß butonuysa)
            if (event && event.target && event.target.classList.contains('tool-btn')) {
                event.target.classList.add('active');
            }
        }

        function selectBrushType(type) {
            brushType = type;
            document.getElementById('roundBrush').classList.remove('active');
            document.getElementById('squareBrush').classList.remove('active');
            document.getElementById('softBrush').classList.remove('active');
            event.target.classList.add('active');
            
            // Brush type deƒüi≈ütirince aracƒ± brush'a √ßek
            if (currentTool !== 'brush' && currentTool !== 'rainbow' && currentTool !== 'eraser') {
                currentTool = 'brush';
                document.querySelectorAll('.tools-section:nth-child(1) .tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.includes('Fƒ±r√ßa') && !btn.textContent.includes('Tipleri')) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function toggleGlow() {
            glowEnabled = !glowEnabled;
            event.target.classList.toggle('active');
            
            // Parlama a√ßƒ±ldƒ±ƒüƒ±nda, eƒüer ≈üekil modundaysak brush'a ge√ß
            if (glowEnabled && !['brush', 'rainbow'].includes(currentTool)) {
                currentTool = 'brush';
                document.querySelectorAll('.tools-section:nth-child(1) .tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.includes('üñåÔ∏è')) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function applyGradient() {
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            gradient.addColorStop(0, '#FF0000');
            gradient.addColorStop(0.17, '#FFA500');
            gradient.addColorStop(0.33, '#FFFF00');
            gradient.addColorStop(0.5, '#00FF00');
            gradient.addColorStop(0.67, '#0000FF');
            gradient.addColorStop(0.83, '#4B0082');
            gradient.addColorStop(1, '#9400D3');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState();
        }

        function initColorPalette() {
            const palette = document.getElementById('colorPalette');
            palette.innerHTML = '';
            
            colors.forEach((color, index) => {
                const btn = document.createElement('div');
                btn.className = 'color-btn' + (index === 0 ? ' active' : '');
                btn.style.backgroundColor = color;
                if (color === '#FFFFFF') {
                    btn.style.border = '3px solid #ddd';
                }
                btn.onclick = () => selectColor(color, btn);
                palette.appendChild(btn);
            });

            document.getElementById('customColorPicker').addEventListener('input', (e) => {
                currentColor = e.target.value;
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            });
        }

        function selectColor(color, btn) {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentColor = color;
            document.getElementById('customColorPicker').value = color;
        }

        function initStickers() {
            const panel = document.getElementById('stickerPanel');
            stickers.forEach(sticker => {
                const btn = document.createElement('button');
                btn.className = 'sticker-btn';
                btn.textContent = sticker;
                btn.onclick = () => addSticker(sticker);
                panel.appendChild(btn);
            });
        }

        function toggleStickers() {
            const panel = document.getElementById('stickerPanel');
            panel.classList.toggle('show');
        }

        let selectedSticker = null;
        let stickerSize = 48;

        function addSticker(sticker) {
            selectedSticker = sticker;
            canvas.style.cursor = 'crosshair';
            toggleStickers();
        }

        function placeSticker(e) {
            if (!selectedSticker) return;
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            ctx.font = `${stickerSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(selectedSticker, x, y);
            
            selectedSticker = null;
            canvas.style.cursor = 'crosshair';
            saveState();
        }

        function floodFill(startX, startY, fillColor) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const targetColor = getPixelColor(imageData, startX, startY);
            
            if (colorsMatch(targetColor, hexToRgb(fillColor))) return;

            const stack = [[startX, startY]];
            const visited = new Set();

            while (stack.length > 0) {
                const [x, y] = stack.pop();
                const key = `${x},${y}`;
                
                if (visited.has(key)) continue;
                if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
                
                const currentColor = getPixelColor(imageData, x, y);
                if (!colorsMatch(currentColor, targetColor)) continue;
                
                visited.add(key);
                setPixelColor(imageData, x, y, hexToRgb(fillColor));
                
                stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
            }

            ctx.putImageData(imageData, 0, 0);
            saveState();
        }

        function getPixelColor(imageData, x, y) {
            const index = (y * imageData.width + x) * 4;
            return {
                r: imageData.data[index],
                g: imageData.data[index + 1],
                b: imageData.data[index + 2],
                a: imageData.data[index + 3]
            };
        }

        function setPixelColor(imageData, x, y, color) {
            const index = (y * imageData.width + x) * 4;
            imageData.data[index] = color.r;
            imageData.data[index + 1] = color.g;
            imageData.data[index + 2] = color.b;
            imageData.data[index + 3] = 255;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16),
                a: 255
            } : { r: 0, g: 0, b: 0, a: 255 };
        }

        function colorsMatch(c1, c2) {
            return c1.r === c2.r && c1.g === c2.g && c1.b === c2.b && c1.a === c2.a;
        }

        function startDrawing(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (currentTool === 'fill') {
                floodFill(Math.floor(x), Math.floor(y), currentColor);
                return;
            }

            if (currentTool === 'text') {
                const overlay = document.getElementById('textInputOverlay');
                const input = document.getElementById('textInput');
                overlay.style.display = 'block';
                overlay.style.left = e.clientX + 'px';
                overlay.style.top = e.clientY + 'px';
                input.value = '';
                input.focus();
                
                input.onkeydown = (evt) => {
                    if (evt.key === 'Enter' && input.value.trim() !== '') {
                        evt.preventDefault();
                        ctx.font = `${brushSize * 4}px ${defaultConfig.font_family}`;
                        ctx.fillStyle = currentColor;
                        ctx.globalAlpha = opacity;
                        ctx.shadowBlur = 0;
                        ctx.fillText(input.value, x, y);
                        ctx.globalAlpha = 1;
                        overlay.style.display = 'none';
                        input.onkeydown = null;
                        saveState();
                    } else if (evt.key === 'Escape') {
                        overlay.style.display = 'none';
                        input.onkeydown = null;
                    }
                };
                return;
            }

            if (['circle', 'rectangle', 'triangle', 'line'].includes(currentTool)) {
                isShapeDrawing = true;
                shapeStartX = x;
                shapeStartY = y;
                tempCanvas = ctx.getImageData(0, 0, canvas.width, canvas.height);
                return;
            }

            isDrawing = true;
            lastX = x;
            lastY = y;
        }

        function draw(e) {
            if (!isDrawing && !isShapeDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (isShapeDrawing) {
                ctx.putImageData(tempCanvas, 0, 0);
                drawShape(shapeStartX, shapeStartY, x, y);
                return;
            }

            ctx.globalAlpha = opacity;
            ctx.lineWidth = brushSize;
            ctx.lineCap = brushType === 'square' ? 'square' : 'round';
            ctx.lineJoin = 'round';

            if (glowEnabled) {
                ctx.shadowBlur = 20;
                ctx.shadowColor = currentColor;
            } else {
                ctx.shadowBlur = 0;
            }

            if (currentTool === 'rainbow') {
                rainbowHue = (rainbowHue + 2) % 360;
                ctx.strokeStyle = `hsl(${rainbowHue}, 100%, 50%)`;
            } else if (currentTool === 'eraser') {
                ctx.strokeStyle = window.elementSdk && window.elementSdk.config.background_color ? 
                    window.elementSdk.config.background_color : defaultConfig.background_color;
                ctx.shadowBlur = 0;
                ctx.globalCompositeOperation = 'destination-out';
            } else {
                ctx.strokeStyle = currentColor;
                ctx.globalCompositeOperation = 'source-over';
            }

            if (brushType === 'soft') {
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, brushSize);
                gradient.addColorStop(0, ctx.strokeStyle);
                gradient.addColorStop(1, 'transparent');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, brushSize, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            lastX = x;
            lastY = y;
        }

        function drawShape(x1, y1, x2, y2) {
            ctx.globalAlpha = opacity;
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;

            if (glowEnabled) {
                ctx.shadowBlur = 20;
                ctx.shadowColor = currentColor;
            } else {
                ctx.shadowBlur = 0;
            }

            ctx.beginPath();

            if (currentTool === 'circle') {
                const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                ctx.arc(x1, y1, radius, 0, Math.PI * 2);
            } else if (currentTool === 'rectangle') {
                ctx.rect(x1, y1, x2 - x1, y2 - y1);
            } else if (currentTool === 'triangle') {
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.lineTo(x1 - (x2 - x1), y2);
                ctx.closePath();
            } else if (currentTool === 'line') {
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
            }

            ctx.stroke();
            ctx.globalAlpha = 1;
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.globalCompositeOperation = 'source-over';
                saveState();
            }
            if (isShapeDrawing) {
                isShapeDrawing = false;
                tempCanvas = null;
                saveState();
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            if (selectedSticker) {
                placeSticker(e);
            } else {
                startDrawing(e);
            }
        });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            if (selectedSticker) {
                placeSticker(touch);
            } else {
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            const mouseEvent = new MouseEvent('mouseup', {});
            canvas.dispatchEvent(mouseEvent);
        });

        document.getElementById('brushSize').addEventListener('input', (e) => {
            brushSize = e.target.value;
            document.getElementById('sizeValue').textContent = brushSize;
        });

        document.getElementById('opacitySlider').addEventListener('input', (e) => {
            opacity = e.target.value / 100;
            document.getElementById('opacityValue').textContent = e.target.value + '%';
        });

        function clearCanvas() {
            ctx.fillStyle = defaultConfig.background_color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState();
        }

        function downloadImage() {
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const link = document.createElement('a');
                link.download = `cizim-${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('ƒ∞ndirme hatasƒ±:', error);
            }
        }

        async function onConfigChange(config) {
            const fontFamily = config.font_family || defaultConfig.font_family;
            const fontSize = config.font_size || defaultConfig.font_size;
            const baseFontStack = 'Arial, sans-serif';

            document.getElementById('mainTitle').textContent = config.main_title || defaultConfig.main_title;
            document.getElementById('mainTitle').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('mainTitle').style.fontSize = `${fontSize * 2}px`;
            document.getElementById('mainTitle').style.color = config.text_color || defaultConfig.text_color;

            document.getElementById('brushSizeLabel').textContent = config.brush_size_label || defaultConfig.brush_size_label;
            document.getElementById('brushSizeLabel').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('brushSizeLabel').style.fontSize = `${fontSize * 0.9}px`;
            document.getElementById('brushSizeLabel').style.color = config.text_color || defaultConfig.text_color;

            document.getElementById('opacityLabel').textContent = config.opacity_label || defaultConfig.opacity_label;
            document.getElementById('opacityLabel').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('opacityLabel').style.fontSize = `${fontSize * 0.9}px`;
            document.getElementById('opacityLabel').style.color = config.text_color || defaultConfig.text_color;

            document.getElementById('toolsLabel').textContent = config.tools_label || defaultConfig.tools_label;
            document.getElementById('toolsLabel').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('toolsLabel').style.fontSize = `${fontSize * 0.85}px`;

            document.getElementById('shapesLabel').textContent = config.shapes_label || defaultConfig.shapes_label;
            document.getElementById('shapesLabel').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('shapesLabel').style.fontSize = `${fontSize * 0.85}px`;

            document.getElementById('brushTypesLabel').textContent = config.brush_types_label || defaultConfig.brush_types_label;
            document.getElementById('brushTypesLabel').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('brushTypesLabel').style.fontSize = `${fontSize * 0.85}px`;

            document.getElementById('undoBtn').textContent = config.undo_button || defaultConfig.undo_button;
            document.getElementById('undoBtn').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('undoBtn').style.fontSize = `${fontSize}px`;
            document.getElementById('undoBtn').style.backgroundColor = config.secondary_action_color || defaultConfig.secondary_action_color;
            document.getElementById('undoBtn').style.color = '#ffffff';

            document.getElementById('redoBtn').textContent = config.redo_button || defaultConfig.redo_button;
            document.getElementById('redoBtn').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('redoBtn').style.fontSize = `${fontSize}px`;
            document.getElementById('redoBtn').style.backgroundColor = config.secondary_action_color || defaultConfig.secondary_action_color;
            document.getElementById('redoBtn').style.color = '#ffffff';

            document.getElementById('clearBtn').textContent = config.clear_button || defaultConfig.clear_button;
            document.getElementById('clearBtn').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('clearBtn').style.fontSize = `${fontSize}px`;
            document.getElementById('clearBtn').style.backgroundColor = config.secondary_action_color || defaultConfig.secondary_action_color;
            document.getElementById('clearBtn').style.color = '#ffffff';

            document.getElementById('downloadBtn').textContent = config.download_button || defaultConfig.download_button;
            document.getElementById('downloadBtn').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('downloadBtn').style.fontSize = `${fontSize}px`;
            document.getElementById('downloadBtn').style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color;
            document.getElementById('downloadBtn').style.color = '#ffffff';

            document.getElementById('stickerLabel').textContent = config.stickers_label || defaultConfig.stickers_label;
            document.getElementById('stickerLabel').style.fontFamily = `${fontFamily}, ${baseFontStack}`;
            document.getElementById('stickerLabel').style.fontSize = `${fontSize}px`;

            const bgColor = config.background_color || defaultConfig.background_color;
            const surfaceColor = config.surface_color || defaultConfig.surface_color;
            
            document.querySelector('.header').style.backgroundColor = '#ffffff';
            document.querySelector('.sidebar').style.backgroundColor = surfaceColor;
            document.querySelector('.canvas-container').style.backgroundColor = '#f0f0f0';
            
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const sliders = document.querySelectorAll('.slider');
            sliders.forEach(slider => {
                slider.style.background = config.primary_action_color || defaultConfig.primary_action_color;
            });
            
            const style = document.createElement('style');
            style.textContent = `
                .slider::-webkit-slider-thumb {
                    background: ${config.primary_action_color || defaultConfig.primary_action_color};
                }
                .slider::-moz-range-thumb {
                    background: ${config.primary_action_color || defaultConfig.primary_action_color};
                }
            `;
            document.head.appendChild(style);
        }

        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: defaultConfig,
                onConfigChange: onConfigChange,
                mapToCapabilities: (config) => ({
                    recolorables: [
                        {
                            get: () => config.background_color || defaultConfig.background_color,
                            set: (value) => {
                                window.elementSdk.config.background_color = value;
                                window.elementSdk.setConfig({ background_color: value });
                            }
                        },
                        {
                            get: () => config.surface_color || defaultConfig.surface_color,
                            set: (value) => {
                                window.elementSdk.config.surface_color = value;
                                window.elementSdk.setConfig({ surface_color: value });
                            }
                        },
                        {
                            get: () => config.text_color || defaultConfig.text_color,
                            set: (value) => {
                                window.elementSdk.config.text_color = value;
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        },
                        {
                            get: () => config.primary_action_color || defaultConfig.primary_action_color,
                            set: (value) => {
                                window.elementSdk.config.primary_action_color = value;
                                window.elementSdk.setConfig({ primary_action_color: value });
                            }
                        },
                        {
                            get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                            set: (value) => {
                                window.elementSdk.config.secondary_action_color = value;
                                window.elementSdk.setConfig({ secondary_action_color: value });
                            }
                        }
                    ],
                    borderables: [],
                    fontEditable: {
                        get: () => config.font_family || defaultConfig.font_family,
                        set: (value) => {
                            window.elementSdk.config.font_family = value;
                            window.elementSdk.setConfig({ font_family: value });
                        }
                    },
                    fontSizeable: {
                        get: () => config.font_size || defaultConfig.font_size,
                        set: (value) => {
                            window.elementSdk.config.font_size = value;
                            window.elementSdk.setConfig({ font_size: value });
                        }
                    }
                }),
                mapToEditPanelValues: (config) => new Map([
                    ['main_title', config.main_title || defaultConfig.main_title],
                    ['brush_size_label', config.brush_size_label || defaultConfig.brush_size_label],
                    ['opacity_label', config.opacity_label || defaultConfig.opacity_label],
                    ['eraser_button', config.eraser_button || defaultConfig.eraser_button],
                    ['undo_button', config.undo_button || defaultConfig.undo_button],
                    ['redo_button', config.redo_button || defaultConfig.redo_button],
                    ['clear_button', config.clear_button || defaultConfig.clear_button],
                    ['download_button', config.download_button || defaultConfig.download_button],
                    ['stickers_label', config.stickers_label || defaultConfig.stickers_label],
                    ['tools_label', config.tools_label || defaultConfig.tools_label],
                    ['shapes_label', config.shapes_label || defaultConfig.shapes_label],
                    ['brush_types_label', config.brush_types_label || defaultConfig.brush_types_label]
                ])
            });
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        initColorPalette();
        initStickers();
        updateUndoRedoButtons();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a6549ad34076852',t:'MTc2NDQ1MjY4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>